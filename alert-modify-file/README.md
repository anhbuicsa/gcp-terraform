# Audit and notify when an user modify the important files
Tracking File Server configuration changes is important as these changes can lead to critical services outage. IT security in charge, therefore, must track changes of files to know who changed the configuration and when. You can easily do it by enabling auditd and configure the watched files. After you have enabled change audit, you configure the ops agent to send the log to stackdriver. After done with above step you can view and investigate all the changes in Stackdriver as well as recieve the notification.

![Alt text](https://github.com/anhbuicsa/gcp-terraform/blob/master/alert-modify-file/images/hacker.png?raw=true "Title")

## Step 1: Install and configure auditd
```
apt-get install auditd 
```
#### Set the log file for auditd by modifying file /etc/audit/auditd.conf 
```
log_file = /var/log/auditd.log 
```
#### Set audit rules by adding lines in file /etc/audit/audit.rules e.g:
```
## This file is automatically generated from /etc/audit/rules.d
-D
-b 8192
-f 1
--backlog_wait_time 0
-w /etc/group -p wa -k identity_bastion
-w /etc/passwd -p wa -k identity_bastion
-w /etc/gshadow -p wa -k identity_bastion
-w /etc/shadow -p wa -k identity_bastion
-w /etc/security/opasswd -p wa -k identity_bastion
-w /opt/restartos.sh -p wa -k identity_bastion
-w /opt/tinyrestart.sh -p wa -k identity_bastion
-w /opt/users.sh -p wa -k identity_bastion
```
#### Restart auditd by running:
```
systemctl is-enabled auditd
systemctl restart auditd  
```
#### Test log by modifying file /opt/tinyrestart.sh 
```
ausearch -f  /opt/restartos.sh 
time->Wed May 25 09:57:11 2022
type=PROCTITLE msg=audit(1653472631.130:7129): proctitle=7669002F6F70742F726573746172746F732E7368
type=PATH msg=audit(1653472631.130:7129): item=0 name="/opt/restartos.sh" inode=423496 dev=08:01 mode=0100755 ouid=0 ogid=0 rdev=00:00 nametype=NORMAL
type=CWD msg=audit(1653472631.130:7129): cwd="/root"
type=SYSCALL msg=audit(1653472631.130:7129): arch=c000003e syscall=188 success=yes exit=0 a0=564693b8ec30 a1=7f3d04c4ee7f a2=564693db78b0 a3=1c items=1 ppid=3196 pid=6262 auid=1137899144 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts12 ses=1057 comm="vi" exe="/usr/bin/vim.basic" key="identity_bastion"
root@bastion:~# id 1137899144
uid=1137899144(v_anhbv2_playground_net) gid=1137899144(v_anhbv2_playground_net) groups=1137899144(v_anhbv2_playground_net)

The v_anhbv2_playground_net has modify the file yet.
or
cat /var/log/auditd.log 


```
## Step 2: Install and configure ops agent
```
sudo apt-cache madison google-cloud-ops-agent 
apt install google-cloud-ops-agent 
```
#### Configure the ops agent to forward the log file to stackdriver logging by modifying file /etc/google-cloud-ops-agent/config.yaml
```
logging:
  receivers:
    auditd:
      type: files
      include_paths:
      - /var/log/auditd.log
  service:
    pipelines:
      default_pipeline:
        receivers: [auditd]
```
#### Restart ops agent to take effect
```
systemctl restart google-cloud-ops-agent 
systemctl status google-cloud-ops-agent 
```
## Step 3: Configure logging and alert
#### 3.1 Go to the Monitoring page and click CREATE POLICY button

![Alt text](https://github.com/anhbuicsa/gcp-terraform/blob/master/alert-modify-file/images/alert.png?raw=true "Title")
#### 3.2 Insert information
![Alt text](https://github.com/anhbuicsa/gcp-terraform/blob/master/alert-modify-file/images/alert1.png?raw=true "Title")
#### 3.3 Insert search key word for searching log
![Alt text](https://github.com/anhbuicsa/gcp-terraform/blob/master/alert-modify-file/images/alert2.png?raw=true "Title")
#### 3.4 Insert notification channel ee.g: email, slack channel
![Alt text](https://github.com/anhbuicsa/gcp-terraform/blob/master/alert-modify-file/images/alert3.png?raw=true "Title")
## Step 4: Check log or Incident Alert
### Alert
![Alt text](https://github.com/anhbuicsa/gcp-terraform/blob/master/alert-modify-file/images/mail-alert.png?raw=true "Title")
### Log

![Alt text](https://github.com/anhbuicsa/gcp-terraform/blob/master/alert-modify-file/images/log.png?raw=true "Title")

### determine who made a change
root@bastion:~# id 1137899144
uid=1137899144(v_anhbv2_playground_net) gid=1137899144(v_anhbv2_playground_net) groups=1137899144(v_anhbv2_playground_net)
