# Audit and notify when an user modify the important files
Tracking File Server configuration changes is important as these changes can lead to critical services outage. IT security in charge, therefore, must track changes of files to know who changed the configuration and when. You can easily do it by enabling auditd and configure the watched files. After you have enabled change audit, you configure the ops agent to send the log to stackdriver. After done with above step you can view and investigate all the changes in Stackdriver as well as recieve the notification.

![Alt text](https://github.com/anhbuicsa/gcp-terraform/blob/master/alert-modify-file/images/hacker.png?raw=true "Title")

## Step 1: Install and configure auditd
```
apt-get install auditd 
```
#### Set the log file for auditd by modifying file /etc/audit/auditd.conf 
```
log_file = /var/log/auditd.log 
```
#### Set audit rules by adding lines in file /etc/audit/audit.rules e.g:
```
## This file is automatically generated from /etc/audit/rules.d
-D
-b 8192
-f 1
--backlog_wait_time 0
-w /etc/group -p wa -k identity_bastion
-w /etc/passwd -p wa -k identity_bastion
-w /etc/gshadow -p wa -k identity_bastion
-w /etc/shadow -p wa -k identity_bastion
-w /etc/security/opasswd -p wa -k identity_bastion
-w /opt/restartos.sh -p wa -k identity_bastion
-w /opt/tinyrestart.sh -p wa -k identity_bastion
-w /opt/users.sh -p wa -k identity_bastion
```
#### Restart auditd by running:
```
systemctl is-enabled auditd
systemctl restart auditd  
```
#### Test log by modifying file /opt/tinyrestart.sh 
```
ausearch -f  /opt/restartos.sh 
or
cat /var/log/auditd.log 
```
## Step 2: Install and configure ops agent
```
sudo apt-cache madison google-cloud-ops-agent 
apt install google-cloud-ops-agent 
```
#### Configure the ops agent to forward the log file to stackdriver logging by modifying file /etc/google-cloud-ops-agent/config.yaml
```
logging:
  receivers:
    auditd:
      type: files
      include_paths:
      - /var/log/auditd.log
  service:
    pipelines:
      default_pipeline:
        receivers: [auditd]
```
#### Restart ops agent to take effect
systemctl restart google-cloud-ops-agent 
systemctl status google-cloud-ops-agent 
## Step 3: Configure logging and alert

apt install google-cloud-ops-agent

